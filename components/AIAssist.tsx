
import React, { useState } from 'react';
import { Modal } from './ui/Modal';
import { AIIcon } from './icons/Icons';
import { Spinner } from './ui/Spinner';
import { Button } from './ui/Button';
import { analyzeTransactionsFromFile } from '../services/geminiService';
import { LocalCsvParser, ParsedColumn, ColumnMapping } from '../services/localCsvParser';
import { AITransaction, Account, AccountPropensity } from '../types';
import { UseDataReturn } from '../hooks/useData';
import { formatCurrency } from '../utils/format';
import { modalFormStyles } from './ui/FormStyles';
import { TransactionPreview } from './ui/TransactionPreview';
import { ProgressBar, ProgressStep } from './ui/ProgressBar';

const AIAssist: React.FC<{data: UseDataReturn}> = ({ data }) => {
  const { accounts, addMultipleTransactions, addAccount } = data;
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [step, setStep] = useState<'method' | 'upload' | 'mapping' | 'account' | 'confirm' | 'loading' | 'error' | 'new-account'>('method');
  const [analyzedTransactions, setAnalyzedTransactions] = useState<AITransaction[]>([]);
  const [selectedAccountId, setSelectedAccountId] = useState<string>(''); // Îπà Í∞íÏúºÎ°ú ÏãúÏûë - ÎÇòÏ§ëÏóê ÏÑ†ÌÉù
  const [errorMessage, setErrorMessage] = useState('');
  const [parseMode, setParseMode] = useState<'ai' | 'local'>('ai');
  const [csvData, setCsvData] = useState<{ headers: string[], rows: string[][] } | null>(null);
  const [parsedColumns, setParsedColumns] = useState<ParsedColumn[]>([]);
  const [columnMapping, setColumnMapping] = useState<ColumnMapping>({});
  const [newAccountForm, setNewAccountForm] = useState({
    name: '',
    propensity: AccountPropensity.CHECKING,
    balance: ''
  });
  const [mappingPreview, setMappingPreview] = useState<AITransaction[]>([]);
  
  // ÏßÑÌñâÎ•† Í¥ÄÎ†® ÏÉÅÌÉú
  const [currentStep, setCurrentStep] = useState(1);
  const [progress, setProgress] = useState(0);

  // AI Ï≤òÎ¶¨ Îã®Í≥Ñ Ï†ïÏùò
  const aiSteps: ProgressStep[] = [
    {
      id: 'file-read',
      label: 'ÌååÏùº ÏùΩÍ∏∞',
      icon: 'üìÅ',
      message: 'ÌååÏùºÏùÑ ÏùΩÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'ai-upload',
      label: 'AI Ï†ÑÏÜ°',
      icon: 'üöÄ',
      message: 'AI ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏÜ°ÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'ai-analysis',
      label: 'AI Î∂ÑÏÑù',
      icon: 'ü§ñ',
      message: 'AIÍ∞Ä Î¨∏ÏÑúÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'data-parsing',
      label: 'Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú',
      icon: 'üîÑ',
      message: 'Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Ï∂îÏ∂úÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    }
  ];

  // CSV Ï≤òÎ¶¨ Îã®Í≥Ñ Ï†ïÏùò
  const csvSteps: ProgressStep[] = [
    {
      id: 'csv-read',
      label: 'ÌååÏùº ÏùΩÍ∏∞',
      icon: 'üìÑ',
      message: 'CSV ÌååÏùºÏùÑ ÏùΩÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'header-analysis',
      label: 'Ìó§Îçî Î∂ÑÏÑù',
      icon: 'üîç',
      message: 'Ïª¨Îüº Ìó§ÎçîÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'column-detection',
      label: 'Ïª¨Îüº Í∞êÏßÄ',
      icon: 'üéØ',
      message: 'Îç∞Ïù¥ÌÑ∞ Ìå®ÌÑ¥ÏùÑ Í∞êÏßÄÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    },
    {
      id: 'auto-mapping',
      label: 'ÏûêÎèô Îß§Ìïë',
      icon: '‚öôÔ∏è',
      message: 'ÏûêÎèô Îß§ÌïëÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...'
    }
  ];

  const currentSteps = parseMode === 'ai' ? aiSteps : csvSteps;

  // Îß§Ìïë Î≥ÄÍ≤ΩÏãú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
  const updateMappingPreview = (mapping: ColumnMapping, csvData: { headers: string[], rows: string[][] }) => {
    try {
      if (!csvData || !mapping.date || !mapping.description || !mapping.amount) {
        setMappingPreview([]);
        return;
      }
      
      // Ï≤òÏùå 3-5Í∞ú ÌñâÎßå ÎØ∏Î¶¨Î≥¥Í∏∞Î°ú Î≥ÄÌôò
      const previewRows = csvData.rows.slice(0, 5);
      const preview = LocalCsvParser.convertToTransactions(
        csvData.headers, 
        previewRows, 
        mapping
      );
      setMappingPreview(preview);
    } catch (error) {
      console.warn('ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ± Ïò§Î•ò:', error);
      setMappingPreview([]);
    }
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setStep('loading');
    setCurrentStep(1);
    setProgress(0);
    
    try {
      if (parseMode === 'ai') {
        // 1Îã®Í≥Ñ: ÌååÏùº ÏùΩÍ∏∞
        setCurrentStep(1);
        setProgress(25);
        await new Promise(resolve => setTimeout(resolve, 500)); // ÏãúÍ∞ÅÏ†Å Ìö®Í≥ºÎ•º ÏúÑÌïú ÎîúÎ†àÏù¥
        
        // 2Îã®Í≥Ñ: AI Ï†ÑÏÜ°
        setCurrentStep(2);
        setProgress(50);
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3-4Îã®Í≥Ñ: AI Î∂ÑÏÑù Î∞è Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
        setCurrentStep(3);
        setProgress(75);
        const results = await analyzeTransactionsFromFile(file);
        
        setCurrentStep(4);
        setProgress(100);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        setAnalyzedTransactions(results);
        setStep('account'); // AI Î∂ÑÏÑù ÌõÑ Í≥ÑÏ¢å ÏÑ†ÌÉù Îã®Í≥ÑÎ°ú
      } else {
        // Î°úÏª¨ ÌååÏã±
        if (!file.name.toLowerCase().endsWith('.csv')) {
          throw new Error('Î°úÏª¨ ÌååÏã±ÏùÄ CSV ÌååÏùºÎßå ÏßÄÏõêÌï©ÎãàÎã§.');
        }
        
        // 1Îã®Í≥Ñ: CSV ÌååÏùº ÏùΩÍ∏∞
        setCurrentStep(1);
        setProgress(25);
        const { headers, rows } = await LocalCsvParser.parseFile(file);
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 2Îã®Í≥Ñ: Ìó§Îçî Î∂ÑÏÑù
        setCurrentStep(2);
        setProgress(50);
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3Îã®Í≥Ñ: Ïª¨Îüº Í∞êÏßÄ
        setCurrentStep(3);
        setProgress(75);
        const columns = LocalCsvParser.analyzeColumns(headers, rows);
        await new Promise(resolve => setTimeout(resolve, 400));
        
        setCsvData({ headers, rows });
        setParsedColumns(columns);
        
        // 4Îã®Í≥Ñ: ÏûêÎèô Îß§Ìïë
        setCurrentStep(4);
        setProgress(100);
        
        // ÏûêÎèô Îß§Ìïë ÏãúÎèÑ (Ïã†Î¢∞ÎèÑ Í∏∞Î∞ò)
        const autoMapping: ColumnMapping = {};
        columns.forEach((col, index) => {
          // ÎÜíÏùÄ Ïã†Î¢∞ÎèÑ(0.7+) ÌïÑÎìúÎì§ÏùÄ ÏûêÎèô Îß§Ìïë
          if (col.confidence > 0.7) {
            switch (col.detectedType) {
              case 'date':
                if (!autoMapping.date) autoMapping.date = index;
                break;
              case 'amount':
                if (!autoMapping.amount) autoMapping.amount = index;
                break;
              case 'description':
                if (!autoMapping.description) autoMapping.description = index;
                break;
              case 'type':
                if (!autoMapping.type) autoMapping.type = index;
                break;
              case 'reference':
                if (!autoMapping.reference) autoMapping.reference = index;
                break;
              case 'category':
                if (!autoMapping.category) autoMapping.category = index;
                break;
              case 'balance':
                if (!autoMapping.balance) autoMapping.balance = index;
                break;
            }
          }
          // Ï§ëÍ∞Ñ Ïã†Î¢∞ÎèÑ(0.5+) ÌïÑÎìúÎì§ÎèÑ Ï∞∏Í≥†Ïö©ÏúºÎ°ú Îß§Ìïë
          else if (col.confidence > 0.5) {
            switch (col.detectedType) {
              case 'reference':
                if (!autoMapping.reference) autoMapping.reference = index;
                break;
              case 'category':
                if (!autoMapping.category) autoMapping.category = index;
                break;
              case 'balance':
                if (!autoMapping.balance) autoMapping.balance = index;
                break;
            }
          }
        });
        
        setColumnMapping(autoMapping);
        // Ï¥àÍ∏∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
        if (csvData) {
          updateMappingPreview(autoMapping, { headers, rows });
        }
        await new Promise(resolve => setTimeout(resolve, 500));
        setStep('mapping');
      }
    } catch (error) {
      setErrorMessage(error instanceof Error ? error.message : "ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
      setStep('error');
    }
  };

  const handleMappingConfirm = () => {
    if (!csvData) return;
    
    try {
      const transactions = LocalCsvParser.convertToTransactions(
        csvData.headers, 
        csvData.rows, 
        columnMapping
      );
      setAnalyzedTransactions(transactions);
      setStep('confirm');
    } catch (error) {
      setErrorMessage(error instanceof Error ? error.message : "Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
      setStep('error');
    }
  };

  const handleConfirm = async () => {
    if (!selectedAccountId) {
        setErrorMessage("Í≥ÑÏ¢åÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
        setStep('error');
        return;
    }
    
    if (selectedAccountId === 'no-account') {
        setErrorMessage("Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÜÏùåÏùÑ ÏÑ†ÌÉùÌïòÏÖ®ÏäµÎãàÎã§. Í∏∞Ï°¥ Í≥ÑÏ¢åÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉà Í≥ÑÏ¢åÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.");
        setStep('error');
        return;
    }
    
    setStep('loading');
    try {
        await addMultipleTransactions(analyzedTransactions, selectedAccountId);
        handleClose();
    } catch (error) {
        setErrorMessage("Í±∞Îûò ÎÇ¥Ïó≠ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        setStep('error');
    }
  };

  const handleCreateAccount = async () => {
    if (!newAccountForm.name.trim()) {
      setErrorMessage("Í≥ÑÏ¢åÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      setStep('error');
      return;
    }
    
    try {
      setStep('loading');
      const accountData = {
        ...newAccountForm,
        balance: parseFloat(newAccountForm.balance as string) || 0
      };
      await addAccount(accountData);
      // ÏÉàÎ°ú ÏÉùÏÑ±Îêú Í≥ÑÏ¢åÎ•º ÏÑ†ÌÉùÌïòÎèÑÎ°ù ÌïòÍ∏∞ ÏúÑÌï¥ accounts Î∞∞Ïó¥Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÍ∏∞Î•º Í∏∞Îã§Î¶ΩÎãàÎã§
      setTimeout(() => {
        const updatedAccounts = data.accounts;
        const newAccount = updatedAccounts.find(acc => acc.name === newAccountForm.name);
        if (newAccount) {
          setSelectedAccountId(newAccount.id);
        }
        setStep('account');
        setNewAccountForm({ name: '', propensity: AccountPropensity.CHECKING, balance: '' });
      }, 100);
    } catch (error) {
      setErrorMessage("Í≥ÑÏ¢å ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
      setStep('error');
    }
  };

  const handleClose = () => {
    setIsModalOpen(false);
    // Reset state after a short delay to allow modal to close smoothly
    setTimeout(() => {
        setStep('method');
        setAnalyzedTransactions([]);
        setErrorMessage('');
        setCsvData(null);
        setParsedColumns([]);
        setColumnMapping({});
        setParseMode('ai');
        setSelectedAccountId('');
        setMappingPreview([]);
        setCurrentStep(1);
        setProgress(0);
        setNewAccountForm({ name: '', propensity: AccountPropensity.CHECKING, balance: '' });
    }, 300);
  };

  return (
    <>
      <Button onClick={() => setIsModalOpen(true)} title="AI Í∞ÄÏ†∏Ïò§Í∏∞" aria-label="AI Í∞ÄÏ†∏Ïò§Í∏∞" variant="accent" size="sm" className="px-2.5 py-1.5">
        <AIIcon />
      </Button>

      <Modal isOpen={isModalOpen} onClose={handleClose} title="Í±∞Îûò ÎÇ¥Ïó≠ Í∞ÄÏ†∏Ïò§Í∏∞">
        {step === 'method' && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">üìÅ Î∂ÑÏÑù Î∞©Î≤ï ÏÑ†ÌÉù</h3>
            <p className="text-slate-600 mb-6">ÌååÏùº Ïú†ÌòïÏóê Îî∞Îùº Ï†ÅÌï©Ìïú Î∂ÑÏÑù Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
            
            <div className="grid grid-cols-1 gap-4 mb-6">
              <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                parseMode === 'ai' 
                  ? 'border-indigo-500 bg-indigo-50' 
                  : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50'
              }`}>
                <input
                  type="radio"
                  value="ai"
                  checked={parseMode === 'ai'}
                  onChange={(e) => setParseMode(e.target.value as 'ai' | 'local')}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-400 mr-3 mt-1"
                />
                <div className="flex-1">
                  <div className="font-semibold text-slate-900 mb-1">ü§ñ AI Ïä§ÎßàÌä∏ Î∂ÑÏÑù</div>
                  <div className="text-sm text-slate-600 mb-2">
                    ÏùÄÌñâ Î™ÖÏÑ∏ÏÑú, Ïπ¥Îìú ÎÇ¥Ïó≠ÏÑú, Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Î∂ÑÏÑù
                  </div>
                  <div className="text-xs text-slate-500">
                    <strong>ÏßÄÏõê ÌòïÏãù:</strong> Ïù¥ÎØ∏ÏßÄ (JPG, PNG), PDF, ÏóëÏÖÄ (XLS, XLSX), CSV
                  </div>
                </div>
              </label>
              
              <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                parseMode === 'local' 
                  ? 'border-indigo-500 bg-indigo-50' 
                  : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50'
              }`}>
                <input
                  type="radio"
                  value="local"
                  checked={parseMode === 'local'}
                  onChange={(e) => setParseMode(e.target.value as 'ai' | 'local')}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-400 mr-3 mt-1"
                />
                <div className="flex-1">
                  <div className="font-semibold text-slate-900 mb-1">üíæ Î°úÏª¨ CSV Ï≤òÎ¶¨</div>
                  <div className="text-sm text-slate-600 mb-2">
                    CSV ÌååÏùºÏùÑ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨ (Îç∞Ïù¥ÌÑ∞ Ïú†Ï∂ú ÏóÜÏùå)
                  </div>
                  <div className="text-xs text-slate-500">
                    <strong>ÏßÄÏõê ÌòïÏãù:</strong> CSV ÌååÏùºÎßå
                  </div>
                </div>
              </label>
            </div>

            <div className={modalFormStyles.actions}>
              <Button
                type="button"
                onClick={() => setStep('upload')}
                variant="primary"
              >
                Îã§Ïùå: ÌååÏùº ÏóÖÎ°úÎìú
              </Button>
            </div>
          </div>
        )}

        {step === 'loading' && (
          <div className="p-6">
            <div className="mb-6 text-center">
              <h3 className="text-lg font-medium text-slate-900 mb-2">
                {parseMode === 'ai' ? 'ü§ñ AI Î¨∏ÏÑú Î∂ÑÏÑù' : 'üíæ CSV ÌååÏùº Ï≤òÎ¶¨'}
              </h3>
              <p className="text-slate-600">
                {parseMode === 'ai' 
                  ? 'Ïù∏Í≥µÏßÄÎä•Ïù¥ Î¨∏ÏÑúÎ•º Î∂ÑÏÑùÌïòÏó¨ Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Ï∂îÏ∂úÌïòÍ≥† ÏûàÏäµÎãàÎã§.' 
                  : 'CSV ÌååÏùºÏùÑ ÏïàÏ†ÑÌïòÍ≤å Î∂ÑÏÑùÌïòÏó¨ Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Ï§ÄÎπÑÌïòÍ≥† ÏûàÏäµÎãàÎã§.'
                }
              </p>
            </div>
            
            <ProgressBar
              currentStep={currentStep}
              totalSteps={currentSteps.length}
              steps={currentSteps}
              percentage={progress}
              showPercentage={true}
              animated={true}
            />
            
            <div className="mt-6 text-center">
              <p className="text-xs text-slate-500">
                {parseMode === 'ai' 
                  ? 'Î∂ÑÏÑù ÏãúÍ∞ÑÏùÄ ÌååÏùº ÌÅ¨Í∏∞ÏôÄ Î≥µÏû°ÎèÑÏóê Îî∞Îùº Îã¨ÎùºÏßà Ïàò ÏûàÏäµÎãàÎã§.'
                  : 'Î°úÏª¨ÏóêÏÑú ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨ÎêòÎ©∞ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïô∏Î∂ÄÎ°ú Ï†ÑÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§.'
                }
              </p>
            </div>
          </div>
        )}

        {step === 'error' && (
          <div className="flex flex-col items-center justify-center min-h-48 text-center p-6">
            <div className="text-4xl mb-4">‚ö†Ô∏è</div>
            <p className="text-red-600 font-semibold text-lg mb-2">Ï≤òÎ¶¨ Ïã§Ìå®</p>
            <p className="mt-2 text-slate-600 mb-6 max-w-md leading-relaxed">{errorMessage}</p>
            
            <div className="flex flex-col sm:flex-row gap-3">
              <Button
                onClick={() => setStep('method')}
                variant="primary"
              >
                üîÑ Îã§Ïãú ÏãúÎèÑ
              </Button>
              
              {/* AI Ïò§Î•òÏù∏ Í≤ΩÏö∞ CSV Î°úÏª¨ Ï≤òÎ¶¨ Ï†úÏïà */}
              {(errorMessage.includes('AI ÏÑúÎπÑÏä§') || errorMessage.includes('Í≥ºÎ∂ÄÌïò') || errorMessage.includes('API')) && (
                <Button
                  onClick={() => {
                    setParseMode('local');
                    setStep('upload');
                    setErrorMessage('');
                  }}
                  variant="secondary"
                >
                  üíæ CSV Î°úÏª¨ Ï≤òÎ¶¨Î°ú Ï†ÑÌôò
                </Button>
              )}
            </div>
          </div>
        )}

        {step === 'account' && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">üè¶ Í≥ÑÏ¢å Ïó∞Í≤∞</h3>
            <p className="text-slate-600 mb-4">Î∂ÑÏÑùÎêú Í±∞ÎûòÎÇ¥Ïó≠ÏùÑ Ïñ¥Îäê Í≥ÑÏ¢åÏóê Ï∂îÍ∞ÄÌï†ÏßÄ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
            
            <div className="mb-6">
              <h4 className="text-md font-medium text-slate-900 mb-3">üìä Î∂ÑÏÑù Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
              <TransactionPreview 
                transactions={analyzedTransactions} 
                maxHeight="max-h-48"
                showSummary={true}
              />
            </div>
            
            {accounts.length > 0 ? (
              <div className="mb-6">
                <legend className={modalFormStyles.label}>Í≥ÑÏ¢å ÏÑ†ÌÉù:</legend>
                <div className="space-y-3 mt-2">
                  {/* Í∏∞Ï°¥ Í≥ÑÏ¢åÎì§ */}
                  {accounts.map(account => (
                    <label key={account.id} className={`flex items-center p-3 border-2 rounded-md cursor-pointer transition-colors ${
                      selectedAccountId === account.id 
                        ? 'border-indigo-500 bg-indigo-50' 
                        : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50'
                    }`}>
                      <input
                        type="radio"
                        value={account.id}
                        checked={selectedAccountId === account.id}
                        onChange={(e) => setSelectedAccountId(e.target.value)}
                        className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-400 mr-3"
                      />
                      <div className="flex-1">
                        <div className="font-medium text-slate-900">{account.name}</div>
                        <div className="text-sm text-slate-600">
                          ÏûîÏï°: {formatCurrency(account.balance)} | {account.propensity}
                        </div>
                      </div>
                    </label>
                  ))}
                  
                  {/* Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÜÏùå ÏòµÏÖò */}
                  <label className={`flex items-center p-3 border-2 rounded-md cursor-pointer transition-colors ${
                    selectedAccountId === 'no-account' 
                      ? 'border-orange-500 bg-orange-50' 
                      : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50'
                  }`}>
                    <input
                      type="radio"
                      value="no-account"
                      checked={selectedAccountId === 'no-account'}
                      onChange={(e) => setSelectedAccountId(e.target.value)}
                      className="h-4 w-4 text-orange-600 focus:ring-orange-500 border-slate-400 mr-3"
                    />
                    <div className="flex-1">
                      <div className="font-medium text-slate-900">‚ùì Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÜÏùå</div>
                      <div className="text-sm text-slate-600">
                        CSVÏóê Í≥ÑÏ¢å Ï†ïÎ≥¥Í∞Ä ÏóÜÍ±∞ÎÇò ÌôïÏã§ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            ) : (
              <div className="mb-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-md">
                <p className="text-yellow-800 font-medium">Í≥ÑÏ¢åÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÉà Í≥ÑÏ¢åÏùÑ ÎßåÎì§Ïñ¥ Ï£ºÏÑ∏Ïöî.</p>
              </div>
            )}

            <div className="mb-6">
              <Button
                type="button"
                onClick={() => setStep('new-account')}
                variant="outline"
                className="w-full p-3 border-2 border-dashed text-slate-600 hover:border-indigo-500 hover:text-indigo-600"
              >
                + ÏÉà Í≥ÑÏ¢å ÏÉùÏÑ±
              </Button>
            </div>

            <div className={modalFormStyles.actions}>
              <Button
                type="button"
                onClick={() => setStep(parseMode === 'local' ? 'mapping' : 'upload')}
                variant="secondary"
              >
                Ïù¥Ï†Ñ
              </Button>
              <Button
                type="button"
                onClick={() => setStep('confirm')}
                disabled={!selectedAccountId}
                variant="primary"
              >
                Îã§Ïùå: ÏµúÏ¢Ö ÌôïÏù∏
              </Button>
            </div>
          </div>
        )}

        {step === 'upload' && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">
              üì§ ÌååÏùº ÏóÖÎ°úÎìú - {parseMode === 'ai' ? 'ü§ñ AI Î∂ÑÏÑù' : 'üíæ CSV Ï≤òÎ¶¨'}
            </h3>
            
            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
              <p className="text-blue-800 text-sm">
                <strong>ÏÑ†ÌÉùÎêú Î∞©Î≤ï:</strong> {parseMode === 'ai' ? 'AI Ïä§ÎßàÌä∏ Î∂ÑÏÑù' : 'Î°úÏª¨ CSV Ï≤òÎ¶¨'}
              </p>
            </div>
            
            <p className="text-slate-600 mb-4">
              {parseMode === 'ai' 
                ? 'ÏùÄÌñâ Î™ÖÏÑ∏ÏÑú, Ïπ¥Îìú ÎÇ¥Ïó≠ÏÑú, ÏóëÏÖÄ ÌååÏùº Îì±ÏùÑ ÏóÖÎ°úÎìúÌïòÎ©¥ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Ï∂îÏ∂úÌï©ÎãàÎã§.'
                : 'CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÎ©¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨Îê©ÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑Ïóê Ï†ÑÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§.'
              }
            </p>
            
            {parseMode === 'ai' && (
              <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-md">
                <p className="text-amber-800 text-sm">
                  üí° <strong>ÌåÅ:</strong> CSV ÌååÏùºÏùò Í≤ΩÏö∞ AIÍ∞Ä ÌÖçÏä§Ìä∏Î°ú Ï≤òÎ¶¨ÌïòÏó¨ Îçî Îπ†Î•¥Í≥† Ï†ïÌôïÌï©ÎãàÎã§. 
                  AI ÏÑúÎπÑÏä§ Ïò§Î•ò Ïãú ÏûêÎèôÏúºÎ°ú Î°úÏª¨ Ï≤òÎ¶¨Î°ú Ï†ÑÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§.
                </p>
              </div>
            )}
            
            <div className="border-2 border-dashed border-slate-400 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors">
              <div className="text-4xl mb-3">
                {parseMode === 'ai' ? 'ü§ñ' : 'üìÅ'}
              </div>
              <label htmlFor="file-upload" className="cursor-pointer text-indigo-600 font-semibold text-lg">
                ÌååÏùº ÏÑ†ÌÉù ÎòêÎäî ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
              </label>
              <input 
                id="file-upload" 
                name="file-upload" 
                type="file" 
                className="sr-only" 
                accept={parseMode === 'ai' ? "image/*,.csv,.pdf,.xls,.xlsx" : ".csv"} 
                onChange={handleFileChange} 
              />
              <p className="text-sm text-slate-600 mt-2">
                {parseMode === 'ai' 
                  ? 'Ïù¥ÎØ∏ÏßÄ (JPG, PNG), PDF, ÏóëÏÖÄ (XLS, XLSX), CSV'
                  : 'CSV ÌååÏùºÎßå ÏßÄÏõê'
                }
              </p>
              <p className="text-xs text-slate-500 mt-1">ÏµúÎåÄ 10MB</p>
            </div>

            <div className={modalFormStyles.actions}>
              <Button
                type="button"
                onClick={() => setStep('method')}
                variant="secondary"
              >
                Ïù¥Ï†Ñ: Î∞©Î≤ï Î≥ÄÍ≤Ω
              </Button>
            </div>
          </div>
        )}

        {step === 'mapping' && csvData && parsedColumns.length > 0 && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">Ïó¥ Îß§Ìïë ÏÑ§Ï†ï</h3>
            <p className="text-slate-600 mb-4">Í∞Å CSV Ïó¥Ïù¥ Î¨¥ÏóáÏùÑ ÎÇòÌÉÄÎÇ¥ÎäîÏßÄ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÏàòÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>
            
            <div className="space-y-3 mb-6">
              {[
                { key: 'date', label: 'ÎÇ†Ïßú', required: true, description: 'Í±∞Îûò Î∞úÏÉù ÏùºÏûê' },
                { key: 'description', label: 'ÏÑ§Î™Ö', required: true, description: 'Í±∞Îûò ÎÇ¥Ïó≠ ÎòêÎäî Í∞ÄÎßπÏ†êÎ™Ö' },
                { key: 'amount', label: 'Í∏àÏï°', required: true, description: 'Í±∞Îûò Í∏àÏï° (ÏñëÏàò/ÏùåÏàò Íµ¨Î∂Ñ)' },
                { key: 'type', label: 'Í±∞Îûò Ïú†Ìòï', required: false, description: 'ÏûÖÍ∏à/Ï∂úÍ∏à/Ïù¥Ï≤¥ Íµ¨Î∂Ñ' },
                { key: 'reference', label: 'Ï∞∏Ï°∞Î≤àÌò∏', required: false, description: 'Í±∞Îûò Í≥†Ïú†Î≤àÌò∏ ÎòêÎäî ÏäπÏù∏Î≤àÌò∏' },
                { key: 'category', label: 'Ïπ¥ÌÖåÍ≥†Î¶¨', required: false, description: 'Í±∞Îûò Ïπ¥ÌÖåÍ≥†Î¶¨ (ÏûêÎèô Î∂ÑÎ•òÏö©)' },
                { key: 'balance', label: 'ÏûîÏï°', required: false, description: 'Í±∞Îûò ÌõÑ Í≥ÑÏ¢å ÏûîÏï°' }
              ].map(({ key, label, required, description }) => (
                <div key={key} className={`rounded-lg border p-4 ${
                  required 
                    ? 'border-red-200 bg-red-50/30' 
                    : 'border-slate-200 bg-slate-50/30'
                }`}>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
                    <div className="space-y-1">
                      <label className="block text-sm font-semibold text-slate-700">
                        {required ? 'üî¥' : 'üîµ'} {label}
                        {required && <span className="text-red-500 ml-1">*</span>}
                      </label>
                      <p className="text-xs text-slate-500 leading-tight">{description}</p>
                    </div>
                    <div className="col-span-2">
                      <select
                        value={columnMapping[key as keyof ColumnMapping] ?? ''}
                        onChange={(e) => {
                          const newMapping = {
                            ...columnMapping,
                            [key]: e.target.value ? parseInt(e.target.value) : undefined
                          };
                          setColumnMapping(newMapping);
                          // Îß§Ìïë Î≥ÄÍ≤ΩÏãú Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                          if (csvData) {
                            updateMappingPreview(newMapping, csvData);
                          }
                        }}
                        className={modalFormStyles.select}
                      >
                        <option value="">{required ? '‚ö†Ô∏è ÌïÑÏàò ÏÑ†ÌÉù' : 'üìã ÏÑ†ÌÉù ÏïàÌï®'}</option>
                        {parsedColumns.map((col, index) => (
                          <option key={index} value={index}>
                            üìä {col.name} ({col.detectedType}, Ïã†Î¢∞ÎèÑ: {(col.confidence * 100).toFixed(0)}%)
                          </option>
                        ))}
                      </select>
                      {columnMapping[key as keyof ColumnMapping] !== undefined && (
                        <div className="mt-2 p-2 bg-white rounded border text-xs">
                          <span className="font-semibold text-green-700">‚úÖ Îß§ÌïëÎêú Í∞í:</span>
                          <span className="ml-2 text-slate-700 font-mono">
                            "{csvData?.rows[0]?.[columnMapping[key as keyof ColumnMapping]!] || 'N/A'}"
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
              <div>
                <h4 className="font-medium text-slate-700 mb-2">üìÑ ÏõêÎ≥∏ CSV Îç∞Ïù¥ÌÑ∞:</h4>
                <div className="max-h-40 overflow-auto border rounded-md bg-slate-50 relative">
                  <table className="w-full text-xs">
                    <thead className="bg-slate-100 sticky top-0 z-10">
                      <tr>
                        {parsedColumns.map((col, index) => (
                          <th key={index} className="p-2 text-left border-r bg-slate-100">
                            {col.name}
                            <br />
                            <span className="text-xs text-slate-500">({col.detectedType})</span>
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {csvData.rows.slice(0, 3).map((row, rowIndex) => (
                        <tr key={rowIndex} className="border-t">
                          {row.map((cell, cellIndex) => (
                            <td key={cellIndex} className="p-2 border-r max-w-24 truncate">
                              {cell}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div>
                <h4 className="font-medium text-slate-700 mb-2">üîÑ Î≥ÄÌôò Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞:</h4>
                <TransactionPreview 
                  transactions={mappingPreview} 
                  maxHeight="max-h-40"
                  showSummary={false}
                />
              </div>
            </div>

            <div className={modalFormStyles.actions}>
              <Button 
                type="button" 
                onClick={() => setStep('account')} 
                variant="secondary"
              >
                Ïù¥Ï†Ñ
              </Button>
              <Button 
                type="button" 
                onClick={() => {
                  console.log('Debug - columnMapping:', columnMapping);
                  console.log('Debug - parsedColumns:', parsedColumns);
                  console.log('Debug - Button enabled conditions:', {
                    hasDate: !!columnMapping.date,
                    hasDescription: !!columnMapping.description,
                    hasAmount: !!columnMapping.amount
                  });
                  handleMappingConfirm();
                }}
                disabled={columnMapping.date === undefined || columnMapping.description === undefined || columnMapping.amount === undefined}
                variant="primary"
              >
                Îã§Ïùå
              </Button>
            </div>
          </div>
        )}
        
        {step === 'confirm' && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">Í±∞Îûò ÎÇ¥Ïó≠ ÌôïÏù∏</h3>
            <p className="text-slate-600 mb-4">Î∞úÍ≤¨Îêú Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Í≤ÄÌÜ†ÌïòÍ≥† ÌôïÏù∏ÌïòÏó¨ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</p>
            <div className="mb-4">
              <div className="bg-indigo-50 border border-indigo-200 p-3 rounded-md">
                <span className={modalFormStyles.label}>ÎåÄÏÉÅ Í≥ÑÏ¢å: </span>
                <span className="text-slate-900 font-medium">
                  {selectedAccountId === 'no-account' 
                    ? '‚ùì Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÜÏùå (Í∏∞Ï°¥ Í≥ÑÏ¢å ÏÑ†ÌÉù ÎòêÎäî ÏÉà Í≥ÑÏ¢å ÏÉùÏÑ± ÌïÑÏöî)'
                    : accounts.find(acc => acc.id === selectedAccountId)?.name || 'Ïïå Ïàò ÏóÜÎäî Í≥ÑÏ¢å'
                  }
                </span>
              </div>
            </div>
            <div className="max-h-64 overflow-y-auto border rounded-md p-2 bg-slate-50 relative">
              <table className="w-full text-sm">
                <thead className="sticky top-0 z-10 bg-slate-50">
                  <tr className="text-left text-slate-600">
                    <th className="p-2 bg-slate-50">ÎÇ†Ïßú</th>
                    <th className="p-2 bg-slate-50">ÏÑ§Î™Ö</th>
                    <th className="p-2 bg-slate-50">Í∏àÏï°</th>
                  </tr>
                </thead>
                <tbody>
                  {analyzedTransactions.map((t, i) => (
                    <tr key={i} className="border-t">
                      <td className="p-2">{t.date}</td>
                      <td className="p-2">{t.description}</td>
                      <td className={`p-2 font-semibold ${t.type === 'INCOME' ? 'text-green-600' : 'text-red-600'}`}>
                        {t.type === 'INCOME' ? '+' : '-'}
                        {formatCurrency(t.amount)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className={modalFormStyles.actions}>
                <Button type="button" onClick={() => setStep('account')} variant="secondary">Ïù¥Ï†Ñ: Í≥ÑÏ¢å Î≥ÄÍ≤Ω</Button>
                <Button 
                  type="button" 
                  onClick={handleConfirm} 
                  disabled={selectedAccountId === 'no-account'}
                  variant="primary"
                >
                  {selectedAccountId === 'no-account' ? 'Í≥ÑÏ¢å ÏÑ†ÌÉù ÌïÑÏöî' : 'ÌôïÏù∏ Î∞è Ï∂îÍ∞Ä'}
                </Button>
            </div>
          </div>
        )}

        {step === 'new-account' && (
          <div className={modalFormStyles.section}>
            <h3 className="text-lg font-medium text-slate-900 mb-4">ÏÉà Í≥ÑÏ¢å ÏÉùÏÑ±</h3>
            <div className="space-y-4">
              <div>
                <label htmlFor="ai-account-name" className={modalFormStyles.label}>Í≥ÑÏ¢åÎ™Ö</label>
                <input 
                  id="ai-account-name"
                  type="text" 
                  value={newAccountForm.name} 
                  onChange={(e) => setNewAccountForm(prev => ({ ...prev, name: e.target.value }))}
                  required 
                  className={modalFormStyles.input} 
                />
              </div>
              <div>
                <label htmlFor="ai-account-type" className={modalFormStyles.label}>Í≥ÑÏ¢å Ïú†Ìòï</label>
                <select 
                  id="ai-account-type"
                  value={newAccountForm.propensity} 
                  onChange={(e) => setNewAccountForm(prev => ({ ...prev, propensity: e.target.value as AccountPropensity }))}
                  className={modalFormStyles.select}
                >
                  {Object.values(AccountPropensity).map(type => 
                    <option key={type} value={type}>{type}</option>
                  )}
                </select>
              </div>
              <div>
                <label htmlFor="ai-account-balance" className={modalFormStyles.label}>Ï¥àÍ∏∞ ÏûîÏï°</label>
                <input 
                  id="ai-account-balance"
                  type="number" 
                  value={newAccountForm.balance} 
                  onChange={(e) => setNewAccountForm(prev => ({ ...prev, balance: e.target.value }))}
                  step="0.01" 
                  placeholder="Ï¥àÍ∏∞ ÏûîÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                  className={modalFormStyles.input} 
                />
              </div>
            </div>
            <div className={modalFormStyles.actions}>
              <Button 
                type="button" 
                onClick={() => setStep('account')} 
                variant="secondary"
              >
                Ï∑®ÏÜå
              </Button>
              <Button 
                type="button" 
                onClick={handleCreateAccount}
                variant="primary"
              >
                Í≥ÑÏ¢å ÏÉùÏÑ±
              </Button>
            </div>
          </div>
        )}
      </Modal>
    </>
  );
};

export default AIAssist;
